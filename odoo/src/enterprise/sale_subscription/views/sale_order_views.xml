<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="sale_subscription_order_view_form" model="ir.ui.view">
        <field name="name">sale.subscription.order.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_management.sale_order_form_quote"/>
        <field name="priority" eval="10"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <field name="is_subscription" invisible="1"/>
                <field name="subscription_state" invisible="1"/>
                <field name="end_date" invisible="1"/>
                <field name="archived_product_count" invisible="1"/>
                <field name="has_recurring_line" invisible="1"/>
            </xpath>
            <button id="create_invoice" position="before">
                <button string="Resume" name="resume_subscription" type="object" data-hotkey="r"
                        class="btn-primary"
                        attrs="{'invisible': [('subscription_state', '!=', '4_paused')]}"/>
            </button>
            <button id="create_invoice" position="attributes">
                <attribute name="attrs">{'invisible': ['|', '&amp;', ('is_subscription', '=', True), ('state', '!=', 'sale'), ('invoice_status', '!=', 'to invoice')]}</attribute>
            </button>
            <button id="create_invoice" position="after">
                <button id="create_invoice_sub" name="%(sale.action_view_sale_advance_payment_inv)d" string="Create Invoice"
                    type="action" class="btn-secondary" data-hotkey="q"
                    attrs="{'invisible': ['|', '|', ('is_subscription', '=', False), ('state', '!=', 'sale'), ('invoice_status', '=', 'to invoice')]}"/>
            </button>
            <button id="create_invoice_percentage" position="attributes">
                <attribute name="attrs">{'invisible': ['|', ('is_subscription', '=', True), '|',('invoice_status', '!=', 'no'), ('state', '!=', 'sale')]}</attribute>
            </button>
            <button name="action_cancel" position="attributes">
                <attribute name="attrs">
                    {'invisible': [ '|', ('id', '=', False),
                                    '|', '&amp;', ('is_subscription','=',False), ('state', 'not in', ['draft', 'sent', 'sale']),
                                    '&amp;', ('is_subscription','=',True),
                                            '|', '|', ('state', 'not in', ['draft', 'sent', 'sale']), ('invoice_count', '>', 0), ('state', 'in', ['cancel'])]
                    }
                </attribute>
            </button>
            <button name="action_cancel" position="before">
                <button string="Create Alternative" name="create_alternative" type="object"
                    attrs="{'invisible': [ '|',
                    ('subscription_state', '!=', '2_renewal'),
                    ('state', 'not in', ['draft', 'sent']),
                    ]}"
                />
            </button>
            <button name="action_cancel" position="after">
                <button string="Upsell" name="prepare_upsell_order" type="object"
                        attrs="{'invisible': [
                        '|', ('is_subscription', '=', False),
                        '|', ('subscription_state', 'not in', ['3_progress', '4_paused']),
                        ('state', '!=', 'sale'),
                        ]}" data-hotkey="z"/>
                <button string="Renew" name="prepare_renewal_order" type="object" data-hotkey="w"
                        attrs="{'invisible': [
                        '|', ('is_subscription', '=', False),
                        '|', ('subscription_state', 'not in', ['3_progress', '4_paused','6_churn']),
                        ('state', '!=', 'sale'),
                        ]}"/>
                <button string="Reopen" name="reopen_order" type="object" data-hotkey="o"
                        attrs="{'invisible': [
                        '|', ('is_subscription', '=', False),
                        '|', ('subscription_state', '!=', '6_churn'),
                        ('state', '!=', 'sale'),
                        ]}"/>
                <!--  Change the label of cancel button for subscription -->
                <button name="%(sale_subscription.sale_subscription_close_reason_wizard_action)d" type="action"
                        string="Close" attrs="{'invisible': ['|', ('subscription_state', 'not in', ['3_progress', '4_paused']), ('id', '=', False)]}"
                        data-hotkey="x"/>
            </button>
            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button attrs="{'invisible': [('is_renewing', '=', False)]}"
                    name="open_subscription_renewal"
                    class="oe_stat_button"
                    icon="fa-repeat"
                    type="object">
                    <field name="renewal_count" widget="statinfo" string="Renewal Quote"/>
                </button>
                <button attrs="{'invisible': [('is_upselling', '=', False)]}"
                    name="open_subscription_upsell"
                    class="oe_stat_button"
                    icon="fa-arrow-circle-o-up"
                    type="object">
                    <field name="upsell_count" widget="statinfo" string="Upsell Quote"/>
                </button>
                <button attrs="{'invisible': [('history_count', '&lt;', 2)]}"
                    name="open_subscription_history"
                    class="oe_stat_button"
                    icon="fa-dollar"
                    type="object">
                    <field name="history_count" widget="statinfo" string="Sales History"/>
                </button>
                <button attrs="{'invisible': ['|', ('is_subscription', '=', False), ('subscription_state', 'in', ['1_draft', '2_renewal'])]}"
                    name="action_sale_order_log"
                    class="oe_stat_button"
                    icon="fa-line-chart"
                    type="object">
                    <field name="recurring_monthly" widget="statinfo" string="MRR"/>
                 </button>
            </xpath>
            <xpath expr="//div[@name='button_box']" position="after">
                <field name="payment_exception" invisible="1"/>
                <div class="px-2 rounded-pill text-bg-danger float-end" attrs="{'invisible': [('payment_exception', '=', False)]}">Payment Failure</div>
                <field name="pending_transaction" invisible="1"/>
                <div class="px-2 rounded-pill text-bg-warning float-end" attrs="{'invisible': [('pending_transaction', '=', False)]}">Pending transaction</div>
                <field name="is_subscription" invisible="1"/>
                <field name="is_upselling"  invisible="1"/>
                <field name="is_renewing"  invisible="1"/>
                <field name="origin_order_id" invisible="1"/>
                <field name="subscription_state" invisible="1"/>
                <button class="float-end fs-6 btn"
                        type="object"
                        name="subscription_open_related"
                        attrs="{'invisible': ['|', ('subscription_state', 'not in', ['2_renewal', '5_renewed', '7_upsell']),
                                              ('state', 'not in', ['draft', 'sent'])]}">
                    <field name="subscription_state"
                           widget="badge"
                           decoration-info="subscription_state in ['2_renewal']"
                           decoration-primary="subscription_state in ['7_upsell']"
                           decoration-secondary="subscription_state in ['5_renewed']"
                    />
                </button>
                <field name="subscription_state" class="float-end fs-6"
                       attrs="{'invisible': ['|', ('subscription_state', 'not in', ['3_progress', '4_paused', '6_churn']), ('state', '=', 'cancel')]}"
                       widget="badge"
                       decoration-info="subscription_state in ['1_draft']"
                       decoration-success="subscription_state in ['3_progress']"
                       decoration-warning="subscription_state in ['4_paused']"
                       decoration-danger="subscription_state in ['6_churn']"
                    />
                <div name="subscription_quotation_pill" class="float-end fs-6 badge rounded-pill text-bg-info"
                     attrs="{'invisible': ['|', ('subscription_state', '!=', '1_draft'), ('state', 'not in', ['draft', 'sent'])]}">Subscription Quotation</div>
            </xpath>
            <xpath expr="//header" position="after">
                <div role="alert" class="alert alert-warning mb-0 p-3 text-center" attrs="{'invisible': [('archived_product_count', '=', 0)]}">
                    <button name="action_archived_product" type="object" class="btn-link">
                        <field name="archived_product_count"/>
                        archived product(s)
                    </button>
                    <span class="align-middle">for this subscription.</span>
                </div>
            </xpath>
            <field name="show_update_pricelist" position='before'>
                <label name="recurrence_label" for="recurrence_id"/>
                <div name="recurrence_block" class="o_row">
                    <field name="recurrence_id" groups="!sales_team.group_sale_manager"
                           attrs="{'readonly': [('subscription_state', 'in', ['3_progress', '4_paused', 'closed', '5_renewed'])]}"
                           domain="[('unit', 'not in', ['hour', 'day'])]"
                           options="{'no_create': True}"/>
                    <field name="recurrence_id" groups="sales_team.group_sale_manager"
                           attrs="{'readonly': [('subscription_state', '=', '7_upsell')]}"
                           domain="[('unit', 'not in', ['hour', 'day'])]"
                           options="{'no_create': True}"/>
                    <span attrs="{'invisible': ['|', ('recurrence_id', '=', False), ('subscription_state', '=', '7_upsell')]}">until</span>
                    <field name="end_date" attrs="{'invisible': ['|', ('recurrence_id', '=', False), ('subscription_state', '=', '7_upsell')]}"/>
                </div>
                <field name="close_reason_id" groups="sales_team.group_sale_manager"
                       attrs="{
                        'invisible': [('subscription_state', '!=', '6_churn')],
                        }"/>            
                <field name="close_reason_id" groups="!sales_team.group_sale_manager"
                       attrs="{
                        'invisible': [('subscription_state', '!=', '6_churn')],
                        'readonly': 1,
                        }"/>
                <field name="next_invoice_date" groups="!sales_team.group_sale_manager"
                       attrs="{
                        'invisible': ['|', ('subscription_state', 'not in', ['3_progress', '4_paused']) , ('recurrence_id', '=', False)],
                        'required': [('recurrence_id', '!=', False), ('state', '=', 'sale')],
                        'readonly': 1,
                        }"/>
                <field name="next_invoice_date" groups="sales_team.group_sale_manager"
                       attrs="{
                        'invisible': ['|', ('subscription_state', 'not in', ['3_progress', '4_paused']) , ('recurrence_id', '=', False)],
                        'required': [('recurrence_id', '!=', False), ('state', '=', 'sale')],
                        }"/>
            </field>
            <field name="sale_order_template_id" position="attributes">
                <attribute name="attrs">{'invisible': ['|', ('state', '=', 'sale'), ('subscription_state', '=', '7_upsell')]}</attribute>
            </field>
            <xpath expr="//notebook/page[@name='order_lines']/field/tree/field[@name='name']" position='after'>
                <field name="temporal_type" invisible="1"/>
            </xpath>
            <xpath expr="//field[@name='order_line']/tree/field[@name='price_subtotal']" position='attributes'>
                <attribute name="decoration-info">temporal_type == 'subscription'</attribute>
            </xpath>
            <xpath expr="//field[@name='order_line']/tree/field[@name='price_total']" position='attributes'>
                <attribute name="decoration-info">temporal_type == 'subscription'</attribute>
            </xpath>
            <xpath expr="//field[@name='analytic_account_id']" position='attributes'>
                <attribute name="attrs">{'readonly': [('invoice_count','!=',0),('state','=','sale'),('is_subscription','=',False)]}</attribute>
            </xpath>
            <xpath expr="//notebook/page[@name='optional_products']/field/tree/field[@name='name']" position='after'>
            </xpath>
            <group name="sale_info" position='before'>
                <group name="subscription_info" string="Subscription"
                    attrs="{'invisible': [('is_subscription', '=', False), ('subscription_state', '!=', '7_upsell')]}">
                    <field name="sale_order_template_id" string="Subscription Plan"/>
                    <field name="start_date" groups="!sales_team.group_sale_manager"
                           attrs="{'readonly': [('subscription_state', 'in', ['2_renew', '3_progress', '4_paused'])]}"/>
                    <field name="start_date" groups="sales_team.group_sale_manager"
                           attrs="{'readonly': [('subscription_state', 'in', ['2_renew' ])]}"/>
                    <field name="first_contract_date" attrs="{'invisible': [('origin_order_id', '=', False)]}"/>
                    <field name="origin_order_id" attrs="{'invisible': [('origin_order_id', '=', False)]}" readonly="1"/>
                    <field name="subscription_id" groups="base.group_no_one" readonly="1"/>
                    <field name="payment_token_id" groups="base.group_no_one" options="{'no_create': 'True'}"/>
                    <field name="payment_exception" groups="base.group_no_one"/>
                    <field name="pending_transaction" groups="base.group_no_one"/>
                </group>
                <field name="commercial_partner_id" invisible="1"/>
            </group>
            <field name="tax_totals" position="after">
                <field name="recurring_details" nolabel="1" colspan="2"/>
            </field>
        </field>
    </record>

    <record id="view_order_tree" model="ir.ui.view">
        <field name="name">sale.order.tree</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-warning">subscription_state == '4_paused'</attribute>
            </xpath>
            <field name="state" position="after">
                <field name="subscription_state" string="Subscription Status" widget="badge"
                   decoration-success="subscription_state == '3_progress'"
                   decoration-warning="subscription_state == '4_paused'"
                   decoration-danger="subscription_state == '6_churn'"
                   decoration-primary="subscription_state == '7_upsell'"
                   decoration-info="subscription_state in ['1_draft', '2_renewal']"
                   readonly="1" optional="hide"/>
                <field name="recurring_total" optional="hide"/>
                <field name="recurrence_id" optional="hide"/>
                <field name="recurring_monthly" optional="hide"/>
            </field>
        </field>
    </record>

    <record id="view_quotation_tree_subscription" model="ir.ui.view">
        <field name="name">sale.order.tree</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">
            <field name="state" position="after">
                <field name="subscription_state" string="Subscription Status" widget="badge"
                   decoration-success="subscription_state == '3_progress'"
                   decoration-warning="subscription_state == '4_paused'"
                   decoration-danger="subscription_state == '6_churn'"
                   decoration-primary="subscription_state == '7_upsell'"
                   decoration-info="subscription_state in ['1_draft', '2_renewal']"
                   readonly="1" optional="hide"/>
                <field name="recurring_total" optional="hide"/>
                <field name="recurrence_id" optional="hide"/>
                <field name="recurring_monthly" optional="hide"/>
            </field>
        </field>
    </record>

    <record id="view_sales_order_filter_subscription" model="ir.ui.view">
        <field name="name">sale.order.filter.subscription</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <filter name="my_sale_orders_filter" position="after">
                <separator/>
                <filter string="Recurring" name="recurring" domain="[('is_subscription', '=', True)]"/>
                <filter string="Not Recurring" name="not_recurring" domain="[('is_subscription', '=', False)]"/>
            </filter>
        </field>
    </record>
</odoo>
